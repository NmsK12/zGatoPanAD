<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 neon-white">
                        <i class="fas fa-users me-2"></i>
                        Gestión de Usuarios
                    </h5>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="fas fa-user-plus me-2"></i>Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0 neon-white">Usuarios Registrados</h6>
            </div>
            <div class="card-body">
                <% if (users.length === 0) { %>
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x neon-purple mb-3"></i>
                        <h6 class="neon-white">No hay usuarios registrados</h6>
                        <p class="neon-purple">Crea el primer usuario para comenzar</p>
                    </div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th class="neon-white">ID</th>
                                    <th class="neon-white">Usuario</th>
                                    <th class="neon-white">Fecha de Creación</th>
                                    <th class="neon-white">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach(user => { %>
                                    <tr>
                                        <td class="neon-cyan">#<%= user.id %></td>
                                        <td class="neon-white">
                                            <i class="fas fa-user me-2"></i>
                                            <%= user.username %>
                                        </td>
                                        <td class="neon-white">
                                            <%= new Date(user.created_at).toLocaleString() %>
                                        </td>
                                        <td>
                                            <% if (user.username !== username) { %>
                                                <button class="btn btn-sm btn-danger" onclick="deleteUser(<%= user.id %>, '<%= user.username %>')">
                                                    <i class="fas fa-trash me-1"></i>
                                                    Eliminar
                                                </button>
                                            <% } else { %>
                                                <span class="text-muted">Usuario actual</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear nuevo usuario -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title neon-white" id="createUserModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Crear Nuevo Usuario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label neon-white">
                            <i class="fas fa-user me-2"></i>
                            Nombre de Usuario
                        </label>
                        <input type="text" class="form-control" id="username" name="username" 
                               placeholder="Ingresa el nombre de usuario" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label neon-white">
                            <i class="fas fa-lock me-2"></i>
                            Contraseña
                        </label>
                        <input type="password" class="form-control" id="password" name="password" 
                               placeholder="Ingresa la contraseña" required>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> El usuario podrá acceder al panel de administración y gestionar API Keys.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="createUser()">
                    <i class="fas fa-user-plus me-2"></i>Crear Usuario
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Función para crear usuario
    function createUser() {
        const form = document.getElementById('createUserForm');
        const formData = new FormData(form);
        
        const data = {
            username: formData.get('username'),
            password: formData.get('password')
        };
        
        fetch('/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showSuccess('Usuario creado correctamente');
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                modal.hide();
                // Limpiar formulario
                form.reset();
                // Recargar página
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showError(result.error || 'Error creando usuario');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error de conexión');
        });
    }
    
    // Función para eliminar usuario
    function deleteUser(userId, username) {
        if (confirm(`¿Estás seguro de que quieres eliminar al usuario "${username}"?`)) {
            fetch(`/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showSuccess('Usuario eliminado correctamente');
                    // Recargar página
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showError(result.error || 'Error eliminando usuario');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error de conexión');
            });
        }
    }
</script>
